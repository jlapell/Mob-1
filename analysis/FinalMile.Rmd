---
title: "LastMile"
author: "Joseph LaPell"
date: "2022-11-21"
output: html_document
---
```{r}
library(tidyverse)
library(here)
library(janitor)
library(lubridate)
library(sf)
library(tmap)
library(geojsonsf)
library(matrixStats)
library(geosphere)
bikeshare = read_csv(here("data_raw", "202209-capitalbikeshare-tripdata.zip")) %>%
  clean_names()
metro_stations = read_csv(here("data_raw", "Metro_Stations_in_DC.csv")) %>%
  clean_names()
```

# Just doing a sample for a monday, this is for September 5, 2022, the first monday of the month.
```{r}
bikeshare1 = bikeshare %>% select(end_station_name,lat = end_lat, lng = end_lng) %>% na.omit() 
metro_stations1 = metro_stations %>% select(end_station_name = name, lat = y, lng = x) %>% na.omit()
```

# https://stackoverflow.com/questions/58831578/minimum-distance-between-lat-long-across-multiple-data-frames
#Finds the closest station to bikes endpoint, adds station name and distance to the bikshare dataframe.

```{r}
#calculate the distance matrix
distmatrix<-distm(bikeshare1[, c(3, 2)], metro_stations1[,c(3, 2)])
#find closest column and get distance
closest<-apply(distmatrix, 1, which.min)
bikeshare1$close_station <- as.character(metro_stations1$end_station_name[closest])
bikeshare1$distance <- apply(distmatrix, 1, min)/1000
```

# Counts the amount of bikes parked within .04572km/150ft, close enough to consider bike being used for final mile.
```{r}
final_mile = bikeshare1 %>% filter(distance < .04572) %>% select(-lat, -lng)
nrow(final_mile)
```

```{r}
library(geojsonsf)
metro_stations_sf = metro_stations = geojson_sf(here("data_raw", "dc_metro_stations.geojson")) %>%
  clean_names() %>% select(close_station = name, metro_location = geometry)
final_mile = final_mile %>% dplyr::group_by(end_station_name, close_station, distance) %>% 
  dplyr::summarise(count = n(), .groups='drop')
final_mile = left_join(final_mile, metro_stations_sf, by="close_station")
```

- convert to sf and do some sort of spatial plot
- density plot/histogram from count
- find start location of bikeshare close to metro station - if distance start to end < 1 mile then use that - find which metro station/bikeshare combination has most users

